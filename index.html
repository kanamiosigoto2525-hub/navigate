<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒˆãƒ©ãƒƒã‚¯ãƒŠãƒ“PRO</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { margin: 0; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* ç”»é¢åˆ‡ã‚Šæ›¿ãˆ */
        .screen { display: none; flex: 1; flex-direction: column; height: 100%; }
        .active { display: flex; }

        /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
        #login-screen { justify-content: center; align-items: center; background: #333; color: white; text-align: center; padding: 20px; }
        .login-btn { background: #4285F4; color: white; padding: 15px 30px; border: none; font-size: 18px; border-radius: 5px; cursor: pointer; }

        /* ãƒ¡ã‚¤ãƒ³åœ°å›³ç”»é¢ */
        #map { flex: 1; width: 100%; }
        .controls { background: #fff; padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; border-top: 2px solid #ccc; }
        .btn { padding: 15px; font-size: 16px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; text-align: center; }
        .btn-rec { background: #dc3545; color: white; grid-column: 1 / 3; } /* èµ¤ï¼šè¨˜éŒ² */
        .btn-memo { background: #ffc107; color: black; } /* é»„ï¼šãƒ¡ãƒ¢ */
        .btn-list { background: #007bff; color: white; } /* é’ï¼šå±¥æ­´ */

        /* å±¥æ­´ãƒªã‚¹ãƒˆç”»é¢ */
        #list-screen { background: #f8f9fa; overflow-y: auto; }
        .header { background: #333; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .route-item { background: white; margin: 10px; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; }
        .route-date { color: #888; font-size: 12px; }
        .route-name { font-size: 18px; font-weight: bold; margin: 5px 0; }
        .back-btn { background: #6c757d; color: white; border: none; padding: 5px 15px; border-radius: 5px; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆä¿å­˜æ™‚ã®åå‰å…¥åŠ›ï¼‰ */
        #save-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 20px; border-radius: 10px; width: 80%; text-align: center; }
        .input-name { width: 90%; padding: 10px; font-size: 18px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="login-screen" class="screen active">
        <h2>ãƒˆãƒ©ãƒƒã‚¯ãƒŠãƒ“ PRO</h2>
        <p>é–¢ä¿‚è€…å°‚ç”¨ãƒ»å®‰å…¨é‹è»¢æ”¯æ´ãƒ„ãƒ¼ãƒ«</p>
        <button class="login-btn" onclick="login()">Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>

    <div id="main-screen" class="screen">
        <div id="map"></div>
        <div class="controls">
            <button id="recBtn" class="btn btn-rec" onclick="toggleRecord()">ğŸ”´ ãƒ«ãƒ¼ãƒˆè¨˜éŒ²é–‹å§‹</button>
            <button class="btn btn-memo" onclick="voiceMemo()">ğŸ¤ å£°ã§ãƒ¡ãƒ¢</button>
            <button class="btn btn-list" onclick="showList()">ğŸ“‚ å±¥æ­´ã‚’è¦‹ã‚‹</button>
        </div>
    </div>

    <div id="list-screen" class="screen">
        <div class="header">
            <span>ä¿å­˜ã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆ</span>
            <button class="back-btn" onclick="showMap()">åœ°å›³ã«æˆ»ã‚‹</button>
        </div>
        <div id="route-list">
            </div>
    </div>

    <div id="save-modal">
        <div class="modal-content">
            <h3>ãƒ«ãƒ¼ãƒˆã‚’ä¿å­˜</h3>
            <input type="text" id="routeName" class="input-name" placeholder="ä¾‹ï¼šæ±äº¬æ¸¯ã€œåŸ¼ç‰å€‰åº«">
            <button class="btn btn-list" onclick="confirmSave()">ä¿å­˜ã™ã‚‹</button>
            <br><br>
            <button style="background:none; border:none; color:#888;" onclick="cancelSave()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>

    <script>
        // â–¼â–¼â–¼â–¼â–¼ ã“ã“ã«ã‚³ãƒ”ãƒ¼ã—ãŸéµã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ â–¼â–¼â–¼â–¼â–¼
        const firebaseConfig = {
          apiKey: "AIzaSyCq4TWpOj6qX1Qry8jRaQB_OzbvmIZEGtc",
  ã€€ã€€ã€€ã€€ authDomain: "trucknavigate.firebaseapp.com",
          projectId: "trucknavigate",
          storageBucket: "trucknavigate.firebasestorage.app",
          messagingSenderId: "429914204126",
          appId: "1:429914204126:web:db852f940aa2fb4dc75f4f",
 
        };
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        // FirebaseåˆæœŸåŒ–
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let map, polyline, currentPath = [], watchId, user;
        let markers = [];

        // --- 1. ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç† ---
        function login() {
            const provider = new firebase.auth.GoogleAuthProvider();
            // ã‚¹ãƒãƒ›ã§ç¢ºå®Ÿãªã€Œãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæ–¹å¼ã€ã«å¤‰æ›´
            auth.signInWithRedirect(provider);
        } 

        auth.onAuthStateChanged((u) => {
            if (u) {
                user = u;
                document.getElementById('login-screen').classList.remove('active');
                document.getElementById('main-screen').classList.add('active');
                initMap();
                alert("ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ: " + user.displayName);
            }
        });

        // --- 2. åœ°å›³åˆæœŸåŒ– ---
        function initMap() {
            if(map) return;
            map = L.map('map').setView([35.6812, 139.7671], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);
            polyline = L.polyline([], { color: 'red', weight: 5 }).addTo(map);

            // ç¾åœ¨åœ°ã¸ç§»å‹•
            map.locate({setView: true, maxZoom: 16});
            map.on('locationfound', (e) => {
                L.circle(e.latlng, {radius: 20}).addTo(map);
            });
        }

        // --- 3. è¨˜éŒ²æ©Ÿèƒ½ ---
        let isRecording = false;
        function toggleRecord() {
            const btn = document.getElementById('recBtn');
            if (!isRecording) {
                // é–‹å§‹
                isRecording = true;
                currentPath = [];
                markers = []; // ãƒ¡ãƒ¢ã‚‚ãƒªã‚»ãƒƒãƒˆ
                polyline.setLatLngs([]);
                btn.innerHTML = "â¬› è¨˜éŒ²çµ‚äº†ï¼ˆä¿å­˜ï¼‰";
                btn.style.background = "#333";
                
                watchId = navigator.geolocation.watchPosition((pos) => {
                    const latlng = [pos.coords.latitude, pos.coords.longitude];
                    currentPath.push(latlng);
                    polyline.setLatLngs(currentPath);
                    map.panTo(latlng);
                }, null, { enableHighAccuracy: true });
            } else {
                // çµ‚äº† â†’ ä¿å­˜ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
                navigator.geolocation.clearWatch(watchId);
                isRecording = false;
                btn.innerHTML = "ğŸ”´ ãƒ«ãƒ¼ãƒˆè¨˜éŒ²é–‹å§‹";
                btn.style.background = "#dc3545";
                document.getElementById('save-modal').style.display = 'flex';
            }
        }

        // ä¿å­˜ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        function cancelSave() {
            document.getElementById('save-modal').style.display = 'none';
            alert("ä¿å­˜ã›ãšã«çµ‚äº†ã—ã¾ã—ãŸ");
        }

        // --- 4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ä¿å­˜ ---
        function confirmSave() {
            const name = document.getElementById('routeName').value;
            if(!name) return alert("ãƒ«ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            db.collection("routes").add({
                name: name,
                driver: user.displayName,
                date: new Date(),
                path: currentPath,
                memos: markers, // ãƒ¡ãƒ¢æƒ…å ±ã‚‚ä¿å­˜
                uid: user.uid
            }).then(() => {
                alert("ä¿å­˜å®Œäº†ï¼");
                document.getElementById('save-modal').style.display = 'none';
                document.getElementById('routeName').value = "";
            }).catch((err) => alert("ã‚¨ãƒ©ãƒ¼: " + err.message));
        }

        // --- 5. éŸ³å£°ãƒ¡ãƒ¢ ---
        function voiceMemo() {
            if (!isRecording) return alert("è¨˜éŒ²ä¸­ã®ã¿ãƒ¡ãƒ¢ã§ãã¾ã™");
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'ja-JP';
            recognition.onresult = (event) => {
                const text = event.results[0][0].transcript;
                const lastPos = currentPath[currentPath.length - 1];
                if(lastPos) {
                    L.marker(lastPos).addTo(map).bindPopup(text).openPopup();
                    markers.push({ lat: lastPos[0], lng: lastPos[1], text: text });
                }
            };
            recognition.start();
        }

        // --- 6. å±¥æ­´è¡¨ç¤º ---
        function showList() {
            document.getElementById('main-screen').classList.remove('active');
            document.getElementById('list-screen').classList.add('active');
            
            const listDiv = document.getElementById('route-list');
            listDiv.innerHTML = "èª­ã¿è¾¼ã¿ä¸­...";

            // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆæ–°ã—ã„é †ï¼‰
            db.collection("routes").orderBy("date", "desc").limit(20).get().then((snap) => {
                listDiv.innerHTML = "";
                snap.forEach((doc) => {
                    const data = doc.data();
                    const dateStr = data.date.toDate().toLocaleString();
                    
                    const div = document.createElement('div');
                    div.className = "route-item";
                    div.innerHTML = `
                        <div class="route-date">${dateStr} - ${data.driver}</div>
                        <div class="route-name">${data.name}</div>
                    `;
                    div.onclick = () => loadRoute(data);
                    listDiv.appendChild(div);
                });
            });
        }

        function showMap() {
            document.getElementById('list-screen').classList.remove('active');
            document.getElementById('main-screen').classList.add('active');
        }

        // --- 7. ãƒ«ãƒ¼ãƒˆå†ç¾ ---
        function loadRoute(data) {
            showMap();
            // æ—¢å­˜ã®ç·šã‚’ã‚¯ãƒªã‚¢ã—ã¦æç”»
            polyline.setLatLngs(data.path);
            // è‰²ã‚’é’ã«å¤‰ãˆã¦ã€Œéå»ã®ãƒ«ãƒ¼ãƒˆã€ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™
            polyline.setStyle({ color: 'blue', opacity: 0.7 });
            
            // åœ°å›³ã®ç¯„å›²ã‚’ãƒ«ãƒ¼ãƒˆå…¨ä½“ã«åˆã‚ã›ã‚‹
            if(data.path.length > 0) {
                const bounds = L.latLngBounds(data.path);
                map.fitBounds(bounds);
            }

            // ãƒ¡ãƒ¢ï¼ˆãƒ”ãƒ³ï¼‰ã‚’å¾©å…ƒ
            if(data.memos) {
                data.memos.forEach(m => {
                    L.marker([m.lat, m.lng]).addTo(map).bindPopup(m.text);
                });
            }
            alert(`ã€Œ${data.name}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚\né’ã„ç·šã«æ²¿ã£ã¦èµ°è¡Œã—ã¦ãã ã•ã„ã€‚`);
        }
    </script>
</body>
</html>


