<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒˆãƒ©ãƒƒã‚¯ãƒ«ãƒ¼ãƒˆè¨˜éŒ²</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; }
        #map { flex: 1; width: 100%; } /* åœ°å›³ã®é«˜ã• */
        .controls { padding: 15px; background: #fff; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .btn {
            display: block; width: 100%; padding: 20px; margin-bottom: 10px;
            font-size: 20px; font-weight: bold; border: none; border-radius: 10px; cursor: pointer;
        }
        .btn-start { background: #007bff; color: #fff; }
        .btn-stop { background: #dc3545; color: #fff; }
        .btn-voice { background: #ffc107; color: #000; }
        textarea { width: 100%; height: 60px; font-size: 16px; margin-top: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="controls">
        <button id="recordBtn" class="btn btn-start" onclick="toggleTracking()">ãƒ«ãƒ¼ãƒˆè¨˜éŒ²é–‹å§‹</button>
        <button id="voiceBtn" class="btn btn-voice" onclick="startVoice()">ğŸ¤ å£°ã§ãƒ¡ãƒ¢ã‚’å…¥ã‚Œã‚‹</button>
        <textarea id="memoText" placeholder="ãƒ¡ãƒ¢ï¼ˆè‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ï¼‰"></textarea>
    </div>

    <script>
        let map, marker, pathLine;
        let tracking = false;
        let watchId = null;
        let coords = []; // é€šã£ãŸé“ã®ç·¯åº¦çµŒåº¦ã‚’ä¿å­˜

        // åœ°å›³ã®åˆæœŸåŒ–ï¼ˆæœ€åˆã¯æ±äº¬ä»˜è¿‘ï¼‰
        map = L.map('map').setView([35.6812, 139.7671], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        pathLine = L.polyline([], {color: 'red', weight: 5}).addTo(map);
        marker = L.circleMarker([0,0], {radius: 8, color: 'blue', fillOpacity: 1}).addTo(map);

        // ãƒ«ãƒ¼ãƒˆè¨˜éŒ²ã®é–‹å§‹ãƒ»åœæ­¢
        function toggleTracking() {
            const btn = document.getElementById('recordBtn');
            if (!tracking) {
                if (!navigator.geolocation) return alert("GPSãŒä½¿ãˆã¾ã›ã‚“");
                tracking = true;
                btn.innerText = "è¨˜éŒ²åœæ­¢ï¼ˆä¿å­˜ï¼‰";
                btn.className = "btn btn-stop";
                
                watchId = navigator.geolocation.watchPosition(pos => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    const newPos = [lat, lng];
                    
                    coords.push(newPos);
                    pathLine.setLatLngs(coords); // ç·šã‚’æ›´æ–°
                    marker.setLatLng(newPos);   // ç¾åœ¨åœ°ãƒãƒ¼ã‚¯ã‚’æ›´æ–°
                    map.panTo(newPos);          // åœ°å›³ã‚’è‡ªåˆ†ä¸­å¿ƒã«
                }, err => console.error(err), {enableHighAccuracy: true});
            } else {
                tracking = false;
                btn.innerText = "ãƒ«ãƒ¼ãƒˆè¨˜éŒ²é–‹å§‹";
                btn.className = "btn btn-start";
                navigator.geolocation.clearWatch(watchId);
                alert("ãƒ«ãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ä¸€æ™‚ä¿å­˜ï¼‰");
            }
        }

        // éŸ³å£°å…¥åŠ›
        function startVoice() {
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'ja-JP';
            recognition.onresult = (event) => {
                const text = event.results[0][0].transcript;
                document.getElementById('memoText').value = text;
                // ãã®å ´æ‰€ã«ãƒ”ãƒ³ã‚’ç«‹ã¦ã‚‹
                if (coords.length > 0) {
                    L.marker(coords[coords.length - 1]).addTo(map).bindPopup(text).openPopup();
                }
            };
            recognition.start();
        }
    </script>
</body>
</html>
