<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒˆãƒ©ãƒƒã‚¯ãƒŠãƒ“PRO</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        * { box-sizing: border-box; }
        body { margin: 0; font-family: sans-serif; height: 100vh; width: 100vw; overflow: hidden; background: #eee; }
        
        /* ç”»é¢å…¨ä½“ã®ç®¡ç† */
        .screen { display: none; height: 100vh; width: 100vw; flex-direction: column; position: absolute; top:0; left:0; }
        .active { display: flex; }

        /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
        #login-screen { justify-content: center; align-items: center; background: #333; color: white; text-align: center; padding: 20px; z-index: 2000; }
        .login-btn { background: #4285F4; color: white; padding: 18px 30px; border: none; font-size: 18px; border-radius: 8px; cursor: pointer; font-weight: bold; }

        /* ãƒ¡ã‚¤ãƒ³ç”»é¢ï¼šåœ°å›³ã¨ãƒœã‚¿ãƒ³ */
        #main-screen { background: white; }
        #map { flex: 1; width: 100%; z-index: 1; } /* åœ°å›³ãŒæœ€èƒŒé¢ã« */
        
        /* æ“ä½œãƒ‘ãƒãƒ«ï¼šã“ã“ãŒè¦‹ãˆãªã„å•é¡Œã‚’ä¿®æ­£ */
        .controls { 
            height: 160px; /* é«˜ã•ã‚’å›ºå®šã—ã¦ç¢ºå®Ÿã«è¦‹ãˆã‚‹ã‚ˆã†ã« */
            background: white; 
            padding: 10px; 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            border-top: 3px solid #ccc;
            z-index: 10;
        }
        .btn { padding: 0; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; height: 60px; }
        .btn-rec { background: #dc3545; color: white; grid-column: 1 / 3; height: 70px; font-size: 18px; }
        .btn-memo { background: #ffc107; color: black; }
        .btn-list { background: #007bff; color: white; }

        /* å±¥æ­´ãƒªã‚¹ãƒˆç”»é¢ */
        #list-screen { background: #f8f9fa; z-index: 100; }
        .header { background: #333; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; height: 60px; }
        #route-list { flex: 1; overflow-y: auto; padding-bottom: 20px; }
        .route-item { background: white; margin: 10px; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .route-date { color: #888; font-size: 12px; }
        .route-name { font-size: 18px; font-weight: bold; margin: 5px 0; color: #333; }
        .back-btn { background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 5px; font-weight: bold; }

        /* ä¿å­˜ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #save-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 3000; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 85%; text-align: center; }
        .input-name { width: 100%; padding: 12px; font-size: 18px; margin-bottom: 15px; border: 2px solid #ccc; border-radius: 5px; }
    </style>
</head>
<body>

    <div id="login-screen" class="screen active">
        <h1>ãƒˆãƒ©ãƒƒã‚¯ãƒŠãƒ“ PRO</h1>
        <p>å®‰å…¨é‹è»¢æ”¯æ´ã‚·ã‚¹ãƒ†ãƒ </p>
        <button class="login-btn" onclick="login()">Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>

    <div id="main-screen" class="screen">
        <div id="map"></div>
        <div class="controls">
            <button id="recBtn" class="btn btn-rec" onclick="toggleRecord()">ğŸ”´ ãƒ«ãƒ¼ãƒˆè¨˜éŒ²é–‹å§‹</button>
            <button class="btn btn-memo" onclick="voiceMemo()">ğŸ¤ å£°ã§ãƒ¡ãƒ¢</button>
            <button class="btn btn-list" onclick="showList()">ğŸ“‚ å±¥æ­´ã‚’è¦‹ã‚‹</button>
        </div>
    </div>

    <div id="list-screen" class="screen">
        <div class="header">
            <strong>ä¿å­˜å±¥æ­´</strong>
            <button class="back-btn" onclick="showMap()">åœ°å›³ã«æˆ»ã‚‹</button>
        </div>
        <div id="route-list"></div>
    </div>

    <div id="save-modal">
        <div class="modal-content">
            <h3>ãƒ«ãƒ¼ãƒˆã‚’ä¿å­˜</h3>
            <input type="text" id="routeName" class="input-name" placeholder="ä¾‹ï¼šæ±äº¬ã€œå¤§é˜ª 430ä¼‘æ†©">
            <button class="btn btn-list" style="width:100%" onclick="confirmSave()">ä¿å­˜ã™ã‚‹</button>
            <button style="margin-top:15px; background:none; border:none; color:#666;" onclick="cancelSave()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>

    <script>
        // â–¼â–¼â–¼ ã‚ãªãŸã® Firebase Config ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ â–¼â–¼â–¼
        const firebaseConfig = {
          apiKey: "AIzaSyCq4TWpOj6qX1Qry8jRaQB_OzbvmIZEGtc",
          authDomain: "trucknavigate.firebaseapp.com",
          projectId: "trucknavigate",
          storageBucket: "trucknavigate.firebasestorage.app",
          messagingSenderId: "429914204126",
          appId: "1:429914204126:web:db852f940aa2fb4dc75f4f",
          measurementId: "G-49DRXDDD72"
        };
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let map, polyline, currentPath = [], watchId, user;
        let markers = [];

        // --- ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¯¾å¿œå¼·åŒ–ï¼‰ ---
        function login() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithRedirect(provider);
        }

        // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‹ã‚‰æˆ»ã£ã¦ããŸæ™‚ã®å‡¦ç†
        auth.getRedirectResult().then((result) => {
            if (result.user) {
                console.log("ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ");
            }
        }).catch((error) => {
            if (error.code !== 'auth/internal-error') { // ç„¡è¦–ã§ãã‚‹ã‚¨ãƒ©ãƒ¼ã‚’é™¤å¤–
                console.error("Auth Error:", error);
            }
        });

        // çŠ¶æ…‹ç›£è¦–
        auth.onAuthStateChanged((u) => {
            if (u) {
                user = u;
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('main-screen').classList.add('active');
                setTimeout(initMap, 500); // ç”»é¢åˆ‡ã‚Šæ›¿ãˆå¾Œã«åœ°å›³ã‚’åˆæœŸåŒ–
            }
        });

        // --- åœ°å›³ ---
        function initMap() {
            if(map) { map.invalidateSize(); return; }
            map = L.map('map').setView([35.68, 139.76], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            polyline = L.polyline([], { color: 'red', weight: 6 }).addTo(map);
            
            map.locate({setView: true, maxZoom: 15});
            map.on('locationfound', (e) => {
                L.circle(e.latlng, {radius: 15, color: 'blue'}).addTo(map);
            });
        }

        // --- è¨˜éŒ² ---
        let isRecording = false;
        function toggleRecord() {
            const btn = document.getElementById('recBtn');
            if (!isRecording) {
                isRecording = true;
                currentPath = [];
                markers = [];
                polyline.setLatLngs([]);
                btn.innerHTML = "â¬› è¨˜éŒ²çµ‚äº†ï¼ˆä¿å­˜ï¼‰";
                btn.style.background = "#333";
                
                watchId = navigator.geolocation.watchPosition((pos) => {
                    const latlng = [pos.coords.latitude, pos.coords.longitude];
                    currentPath.push(latlng);
                    polyline.setLatLngs(currentPath);
                    map.panTo(latlng);
                }, (err) => { console.error(err); }, { enableHighAccuracy: true });
            } else {
                navigator.geolocation.clearWatch(watchId);
                isRecording = false;
                btn.innerHTML = "ğŸ”´ ãƒ«ãƒ¼ãƒˆè¨˜éŒ²é–‹å§‹";
                btn.style.background = "#dc3545";
                if(currentPath.length > 0) {
                    document.getElementById('save-modal').style.display = 'flex';
                } else {
                    alert("ç§»å‹•ãƒ‡ãƒ¼ã‚¿ãŒãªã„ãŸã‚ä¿å­˜ã§ãã¾ã›ã‚“");
                }
            }
        }

        function cancelSave() {
            document.getElementById('save-modal').style.display = 'none';
        }

        // --- ä¿å­˜å‡¦ç†ï¼ˆä¸å…·åˆä¿®æ­£æ¸ˆã¿ï¼‰ ---
        function confirmSave() {
            const name = document.getElementById('routeName').value;
            if(!name) return alert("ãƒ«ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            if(!user) return alert("ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");

            // ä¿å­˜å‡¦ç†
            db.collection("routes").add({
                name: name,
                driver: user.displayName || "ãƒ‰ãƒ©ã‚¤ãƒãƒ¼",
                date: firebase.firestore.FieldValue.serverTimestamp(),
                path: currentPath,
                memos: markers,
                uid: user.uid
            }).then(() => {
                alert("ä¿å­˜å®Œäº†ï¼");
                document.getElementById('save-modal').style.display = 'none';
                document.getElementById('routeName').value = "";
                currentPath = [];
                polyline.setLatLngs([]);
            }).catch((err) => {
                console.error(err);
                alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + err.message);
            });
        }

        // --- å±¥æ­´è¡¨ç¤º ---
        function showList() {
            document.getElementById('main-screen').classList.remove('active');
            document.getElementById('list-screen').classList.add('active');
            
            const listDiv = document.getElementById('route-list');
            listDiv.innerHTML = "<p style='padding:20px'>èª­ã¿è¾¼ã¿ä¸­...</p>";

            db.collection("routes").orderBy("date", "desc").limit(20).get().then((snap) => {
                listDiv.innerHTML = "";
                if(snap.empty) { listDiv.innerHTML = "<p style='padding:20px'>å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p>"; }
                snap.forEach((doc) => {
                    const data = doc.data();
                    const d = data.date ? data.date.toDate() : new Date();
                    const div = document.createElement('div');
                    div.className = "route-item";
                    div.innerHTML = `
                        <div class="route-date">${d.toLocaleString()} - ${data.driver}</div>
                        <div class="route-name">${data.name}</div>
                        <button class="btn-list" style="padding:5px 10px; height:auto; width:100%" onclick='event.stopPropagation(); loadRoute(${JSON.stringify(data)})'>ã“ã®ãƒ«ãƒ¼ãƒˆã‚’åœ°å›³ã«è¡¨ç¤º</button>
                    `;
                    listDiv.appendChild(div);
                });
            }).catch(err => {
                listDiv.innerHTML = "èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + err.message;
            });
        }

        function showMap() {
            document.getElementById('list-screen').classList.remove('active');
            document.getElementById('main-screen').classList.add('active');
            if(map) map.invalidateSize();
        }

        function loadRoute(data) {
            showMap();
            polyline.setLatLngs(data.path);
            polyline.setStyle({ color: 'blue', weight: 8 });
            if(data.path.length > 0) map.fitBounds(L.latLngBounds(data.path));
            alert("éå»ã®ãƒ«ãƒ¼ãƒˆã‚’é’è‰²ã§è¡¨ç¤ºã—ã¾ã—ãŸ");
        }

        function voiceMemo() {
            if (!isRecording) return alert("è¨˜éŒ²ä¸­ã®ã¿ãƒ¡ãƒ¢ã§ãã¾ã™");
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'ja-JP';
            recognition.onresult = (event) => {
                const text = event.results[0][0].transcript;
                const lastPos = currentPath[currentPath.length - 1];
                if(lastPos) {
                    L.marker(lastPos).addTo(map).bindPopup(text).openPopup();
                    markers.push({ lat: lastPos[0], lng: lastPos[1], text: text });
                }
            };
            recognition.start();
        }
    </script>
</body>
</html>

