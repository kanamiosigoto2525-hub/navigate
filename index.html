<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒˆãƒ©ãƒƒã‚¯ãƒŠãƒ“PRO</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* åŸºæœ¬è¨­å®šï¼šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ã€å…¨ç”»é¢è¡¨ç¤º */
        body { margin: 0; padding: 0; font-family: sans-serif; height: 100vh; width: 100vw; overflow: hidden; background: #eee; }
        
        /* ç”»é¢ç®¡ç† */
        .screen { display: none; height: 100%; width: 100%; position: absolute; top: 0; left: 0; flex-direction: column; background: white; }
        .active { display: flex !important; z-index: 10; }

        /* 1. ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
        #login-screen { justify-content: center; align-items: center; background: #333; color: white; z-index: 2000; }
        .login-btn { background: #4285F4; color: white; padding: 15px 30px; border: none; font-size: 16px; border-radius: 5px; cursor: pointer; }

        /* 2. åœ°å›³ç”»é¢ */
        #main-screen { position: relative; }
        #map { flex: 1; width: 100%; height: 100%; z-index: 1; }

        /* æ“ä½œãƒ‘ãƒãƒ«ï¼ˆä¿®æ­£ï¼šç”»é¢ä¸‹éƒ¨ã«å›ºå®šè¡¨ç¤ºï¼‰ */
        .controls { 
            position: absolute; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            height: 140px; 
            background: rgba(255, 255, 255, 0.95); 
            padding: 10px; 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            grid-template-rows: 1fr 1fr;
            gap: 8px; 
            border-top: 2px solid #ccc;
            z-index: 1000; /* åœ°å›³ã‚ˆã‚Šç¢ºå®Ÿã«ä¸Šã« */
        }
        .btn { border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 14px; }
        .btn-rec { grid-column: 1 / 3; background: #dc3545; color: white; font-size: 18px; } /* ä¸Šæ®µå…¨å¹… */
        .btn-memo { background: #ffc107; color: black; } /* ä¸‹æ®µå·¦ */
        .btn-list { background: #007bff; color: white; } /* ä¸‹æ®µå³ */

        /* 3. å±¥æ­´ç”»é¢ */
        #list-screen { background: #f8f9fa; z-index: 3000; }
        .header { background: #333; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; height: 50px; flex-shrink: 0; }
        #route-list { flex: 1; overflow-y: auto; padding: 10px; }
        .route-item { background: white; margin-bottom: 10px; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .back-btn { background: #6c757d; color: white; border: none; padding: 5px 15px; border-radius: 3px; font-size: 14px; }

        /* ä¿å­˜ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #save-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 4000; }
        .modal-content { background: white; padding: 20px; border-radius: 10px; width: 85%; text-align: center; }
        .input-name { width: 90%; padding: 10px; font-size: 16px; margin-bottom: 15px; border: 1px solid #ddd; }
    </style>
</head>
<body>

    <div id="login-screen" class="screen active">
        <h2>ãƒˆãƒ©ãƒƒã‚¯ãƒŠãƒ“ PRO</h2>
        <p>ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦é–‹å§‹</p>
        <button class="login-btn" onclick="login()">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>

    <div id="main-screen" class="screen">
        <div id="map"></div>
        <div class="controls">
            <button id="recBtn" class="btn btn-rec" onclick="toggleRecord()">ğŸ”´ è¨˜éŒ²é–‹å§‹</button>
            <button class="btn btn-memo" onclick="voiceMemo()">ğŸ¤ éŸ³å£°ãƒ¡ãƒ¢</button>
            <button class="btn btn-list" onclick="showList()">ğŸ“‚ å±¥æ­´ç¢ºèª</button>
        </div>
    </div>

    <div id="list-screen" class="screen">
        <div class="header">
            <span>èµ°è¡Œå±¥æ­´</span>
            <button class="back-btn" onclick="showMap()">æˆ»ã‚‹</button>
        </div>
        <div id="route-list">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <div id="save-modal">
        <div class="modal-content">
            <h3>è¨˜éŒ²ã‚’ä¿å­˜</h3>
            <input type="text" id="routeName" class="input-name" placeholder="ãƒ«ãƒ¼ãƒˆåã‚’å…¥åŠ›">
            <button class="btn btn-list" style="width:100%; padding:10px;" onclick="confirmSave()">ä¿å­˜ã™ã‚‹</button>
            <br><br>
            <button style="background:none; border:none; color:#666;" onclick="cancelSave()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>

    <script>
        // â–¼â–¼â–¼ éµã®è²¼ã‚Šä»˜ã‘å ´æ‰€ â–¼â–¼â–¼
        const firebaseConfig = {
          apiKey: "AIzaSyCq4TWpOj6qX1Qry8jRaQB_OzbvmIZEGtc",
          authDomain: "trucknavigate.firebaseapp.com",
          projectId: "trucknavigate",
          storageBucket: "trucknavigate.firebasestorage.app",
          messagingSenderId: "429914204126",
          appId: "1:429914204126:web:db852f940aa2fb4dc75f4f",
          measurementId: "G-49DRXDDD72"  
        };
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        // FirebaseåˆæœŸåŒ–
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let user = null;

        // --- 1. ãƒ­ã‚°ã‚¤ãƒ³é–¢é€£ ---
        function login() {
            auth.signInWithRedirect(new firebase.auth.GoogleAuthProvider());
        }

        // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ç›£è¦–
        auth.onAuthStateChanged((u) => {
            if (u) {
                user = u;
                document.getElementById('login-screen').classList.remove('active');
                document.getElementById('main-screen').classList.add('active');
                // åœ°å›³ã®è¡¨ç¤ºå´©ã‚Œã‚’é˜²ããŸã‚å°‘ã—å¾…ã£ã¦åˆæœŸåŒ–
                setTimeout(initMap, 500);
            }
        });

        // --- 2. åœ°å›³é–¢é€£ ---
        let map, polyline, currentPath = [];
        let watchId = null;
        let markers = [];

        function initMap() {
            if (map) { map.invalidateSize(); return; } // ã™ã§ã«ã‚ã‚Œã°ã‚µã‚¤ã‚ºèª¿æ•´ã®ã¿
            
            map = L.map('map').setView([35.6812, 139.7671], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap'
            }).addTo(map);
            polyline = L.polyline([], { color: 'red', weight: 5 }).addTo(map);

            map.locate({setView: true, maxZoom: 16});
            map.on('locationfound', (e) => {
                L.circle(e.latlng, {radius: 20}).addTo(map);
            });
        }

        // --- 3. è¨˜éŒ²ãƒ»ä¿å­˜é–¢é€£ ---
        let isRecording = false;

        function toggleRecord() {
            const btn = document.getElementById('recBtn');
            if (!isRecording) {
                // é–‹å§‹
                isRecording = true;
                currentPath = [];
                markers = [];
                polyline.setLatLngs([]);
                btn.innerHTML = "â¬› çµ‚äº†ã—ã¦ä¿å­˜";
                btn.style.background = "#333";

                if(navigator.geolocation){
                    watchId = navigator.geolocation.watchPosition((pos) => {
                        const lat = pos.coords.latitude;
                        const lng = pos.coords.longitude;
                        currentPath.push([lat, lng]);
                        polyline.setLatLngs(currentPath);
                        map.panTo([lat, lng]);
                    }, (err) => console.log(err), { enableHighAccuracy: true });
                }
            } else {
                // çµ‚äº†
                isRecording = false;
                navigator.geolocation.clearWatch(watchId);
                btn.innerHTML = "ğŸ”´ è¨˜éŒ²é–‹å§‹";
                btn.style.background = "#dc3545";
                
                // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿ä¿å­˜ç”»é¢ã¸
                if(currentPath.length > 0) {
                    document.getElementById('save-modal').style.display = 'flex';
                } else {
                    alert("ç§»å‹•ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
                }
            }
        }

        function cancelSave() {
            document.getElementById('save-modal').style.display = 'none';
        }

        function confirmSave() {
            const nameEl = document.getElementById('routeName');
            const name = nameEl.value;

            if (!name) { alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
            if (!user) { alert("ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼ï¼šå†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„"); return; }

            // ä¿å­˜å®Ÿè¡Œ
            db.collection("routes").add({
                name: name,
                driver: user.displayName,
                uid: user.uid,
                date: firebase.firestore.FieldValue.serverTimestamp(),
                path: currentPath,
                memos: markers
            }).then(() => {
                alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
                document.getElementById('save-modal').style.display = 'none';
                nameEl.value = "";
                currentPath = []; // ãƒ‘ã‚¹ãƒªã‚»ãƒƒãƒˆ
                polyline.setLatLngs([]); // ç·šãƒªã‚»ãƒƒãƒˆ
            }).catch((error) => {
                alert("ä¿å­˜å¤±æ•—: " + error.message);
            });
        }

        // --- 4. å±¥æ­´ãƒ»ç”»é¢é·ç§»é–¢é€£ ---
        function showList() {
            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('main-screen').classList.remove('active');
            document.getElementById('list-screen').classList.add('active');

            const listDiv = document.getElementById('route-list');
            listDiv.innerHTML = "èª­ã¿è¾¼ã¿ä¸­...";

            db.collection("routes").orderBy("date", "desc").limit(20).get()
            .then((snapshot) => {
                listDiv.innerHTML = "";
                if(snapshot.empty) {
                    listDiv.innerHTML = "å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“";
                    return;
                }
                snapshot.forEach((doc) => {
                    const d = doc.data();
                    const dateStr = d.date ? d.date.toDate().toLocaleString() : "æ—¥æ™‚ä¸æ˜";
                    
                    const item = document.createElement('div');
                    item.className = "route-item";
                    item.innerHTML = `
                        <div style="font-size:12px; color:#888;">${dateStr} - ${d.driver}</div>
                        <div style="font-size:16px; font-weight:bold;">${d.name}</div>
                    `;
                    item.onclick = () => loadRoute(d);
                    listDiv.appendChild(item);
                });
            })
            .catch((err) => {
                listDiv.innerHTML = "ã‚¨ãƒ©ãƒ¼: " + err.message;
            });
        }

        function showMap() {
            // åœ°å›³ã«æˆ»ã‚‹å‡¦ç†
            document.getElementById('list-screen').classList.remove('active');
            document.getElementById('main-screen').classList.add('active');
            
            // åœ°å›³ã®å†æç”»ï¼ˆã‚°ãƒ¬ãƒ¼è¡¨ç¤ºå¯¾ç­–ï¼‰
            setTimeout(() => {
                if(map) map.invalidateSize();
            }, 100);
        }

        function loadRoute(data) {
            showMap();
            // éå»ã®ãƒ«ãƒ¼ãƒˆã‚’æç”»
            if(data.path && data.path.length > 0) {
                polyline.setLatLngs(data.path);
                polyline.setStyle({ color: 'blue', opacity: 0.7 });
                map.fitBounds(L.latLngBounds(data.path));
                alert("é’ã„ç·šã§ãƒ«ãƒ¼ãƒˆã‚’è¡¨ç¤ºã—ã¾ã—ãŸ");
            }
            // ãƒ¡ãƒ¢å¾©å…ƒ
            if(data.memos) {
                data.memos.forEach(m => {
                    L.marker([m.lat, m.lng]).addTo(map).bindPopup(m.text);
                });
            }
        }

        // --- 5. éŸ³å£°ãƒ¡ãƒ¢ ---
        function voiceMemo() {
            if(!isRecording) return alert("è¨˜éŒ²ä¸­ã®ã¿ä½¿ç”¨ã§ãã¾ã™");
            
            // ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§å¯¾å¿œ
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) return alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“");

            const recognition = new SpeechRecognition();
            recognition.lang = 'ja-JP';
            recognition.onresult = (event) => {
                const text = event.results[0][0].transcript;
                if(currentPath.length > 0) {
                    const lastPos = currentPath[currentPath.length - 1];
                    L.marker(lastPos).addTo(map).bindPopup(text).openPopup();
                    markers.push({ lat: lastPos[0], lng: lastPos[1], text: text });
                }
            };
            recognition.start();
        }
    </script>
</body>
</html>
